<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smoke Timer</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #0f0f0f;
      color: #ffffff;
      font-family: system-ui, sans-serif;
      text-align: center;
    }
    button {
      font-size: 1.5rem;
      padding: 20px 40px;
      background-color: #1e90ff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    #countdown {
      margin-top: 15px;
      font-size: 1.25rem;
    }
  </style>
</head>
<body>
  <div>
    <button id="startButton">Start 1-hour timer</button>
    <div id="countdown">00:00</div>
  </div>

  <script>
    var startButton = document.getElementById('startButton');
    var countdown = document.getElementById('countdown');
    var interval;

    function updateCountdown() {
      var now = new Date().getTime();
      var endTime = localStorage.getItem('endTime');
      if (!endTime) return;

      endTime = parseInt(endTime, 10);
      var timeLeft = endTime - now;

      if (timeLeft <= 0) {
        clearInterval(interval);
        localStorage.removeItem('endTime');
        countdown.innerText = "00:00";
        startButton.disabled = false;
        if ("vibrate" in navigator) navigator.vibrate(200);

        if (Notification.permission === "granted") {
          new Notification("You can smoke now!");
        } else if (Notification.permission === "default") {
          Notification.requestPermission();
        }

        alert("You can smoke now!");
      } else {
        var minutes = Math.floor(timeLeft / 60000);
        var seconds = Math.floor((timeLeft % 60000) / 1000);
        countdown.innerText = (minutes < 10 ? '0' : '') + minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
      }
    }

    function startTimer() {
      var endTime = new Date().getTime() + (60 * 60 * 1000); // 1 hour
      localStorage.setItem('endTime', endTime);
      startButton.disabled = true;
      updateCountdown();
      interval = setInterval(updateCountdown, 1000);
    }

    startButton.addEventListener('click', startTimer);

    // Check if timer was ongoing
    if (localStorage.getItem('endTime')) {
      updateCountdown();
      interval = setInterval(updateCountdown, 1000);
      startButton.disabled = true;
    }

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(function(error) {
        console.error('Service Worker registration failed:', error);
      });
    }

    // Ask for notification permission
    if ('Notification' in window && Notification.permission === "default") {
      Notification.requestPermission();
    }
  </script>
</body>
</html>
